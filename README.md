# C4TUNE - C<sub>4</sub> TUNing Engine

## General description
A detailed description can be found in the associated publication: \[REFERENCE\]

This repository contains the code files of a neural network for the prediction of parameters of the C<sub>4</sub> dynamic photosynthesis model (Wang et al. 2021, doi: [10.1111/tpj.15365](https://doi.org/10.1111/tpj.15365).

The neural network - C4TUNE - was trained using an artificial dataset that was generated by sampling parameter vectors and carrying out simulations of A/Ca and A/Q curves, which are referred to as A/CO<sub>2</sub> and A/light curves for simplicity.

C4TUNE takes as inputs A/CO<sub>2</sub> and A/light curves, the changing CO<sub>2</sub> and light levels used the generate the curves, and the respective constant light and CO<sub>2</sub> levels.

The training of C4TUNE was guided by minimizing a loss function, which involved the relative error of parameter predictions as well as a simulation error term. The simulation error was assessed by predicting A/CO<sub>2</sub> and A/light curves with the predicted parameters and calculating the mean squared error to the two input curves.

Since the curve simulation using the Matlab implementation of the C<sub>4</sub> photosynthesis model would have been too slow, we trained a surrogate model to predict A/CO<sub>2</sub> and A/light curves from parameter vectors and environmental inputs. The surrogate model is also a neural network that was trained on the same dataset.

## Installation

1) Clone the git repository
```git clone https://github.com/pwendering/C4TUNE```
2) Install the Python requirements in a virtual environment
```conda env create -f environment.yml```

To be able to run simulations with the C<sub>4</sub> kinetic model from within Python, you also need to install the module `matlabengine`:
```pip install matlabengine```

3) Set the path to the C4TUNE directory
The base configuration file can be found at `config/base.yaml`. Set the value of `base_dir` to the absolute path of the C4TUNE directory: `/path/to/C4TUNE`.

### Training dataset

The training set is relatively large, so it needs to be downloaded separately if needed. 
The dataset can be found at [REFERENCE].
Make sure the uncompress the files before use.

## Usage

### Python script
Here is a snippet showing the minimal steps to carry out parameter predictions:

The two input files `a_co2_measurements.csv` and `a_light_measurements.csv` contain the average experimental measurements.
The rows contain the different genotypes or repetitions and the columns correspond to the different CO<sub>2</sub> or light steps, respectively.
The model was trained on a dataset that relied on a specific number and values of CO<sub>2</sub> and light levels. Therefore, the number of ambient CO<sub>2</sub> partial pressures must be 11 and the columns must correspond to measurements at 25, 75, 100, 200, 250, 300, 400, 600, 800, 1000, and 1250 µbar in this order. Equivalently, the columns in the file containing A/light curves must correspond to measurements at 50, 150, 300, 500, 1100, and 1800 µmol m<sup>-2</sup> s<sup>-1</sup>. The constant light intensity for the A/CO<sub>2</sub> curves must be 1800 µmol m<sup>-2</sup> s<sup>-1</sup> and the constant ambient CO<sub>2</sub> partial pressure for A/light curves must be 400 µbar.

```
import os
import sys
from pathlib import Path
import torch
from torch import FloatTensor
import numpy as np
import pandas as pd

sys.path.append(str(Path().resolve().parents[0]))

from src.models.model_c4tune import ParameterPredictionModel
from src.prediction.c4tune_predictor import C4tunePredictor
from src.utils.env_setup import set_training_environment, get_config
from src.data.data import PhotResponseDataset

# ===== Load model and data

# get C4TUNE and surrogate model configurations
base_config_file = "config/base.yaml"
c4tune_config_file = "config/c4tune.yaml"
config_c4tune = get_config(base_config_file, c4tune_config_file)

# numpy random seed 
np.random.seed(config_c4tune.training.rng_seed)

# model weights after training
c4tune_checkpoint = os.path.join(config_c4tune.paths.run_dir, "2025-03-21", "c4tune-epoch-60.pth")

# Load Cholesky decomposition matrix and change the model's property
L = np.loadtxt(config_c4tune.paths.cholesky_test, delimiter=',')

# create C4TUNE and surrogate model predictors
set_training_environment(config_c4tune)
device = torch.device(config_c4tune.training.device if torch.cuda.is_available() else "cpu")
c4tune_model = ParameterPredictionModel(config_c4tune.model, L=FloatTensor(L))
c4tune = C4tunePredictor(c4tune_model, c4tune_checkpoint, device, config_c4tune)

# Load the training dataset 
dataset = PhotResponseDataset(config_c4tune.paths.datasets)

# Load Anet measurements from a CSV file
a_co2_file = "a_co2_measurements.csv"  # example file name
a_light_file = "a_light_measurements.csv"  # example file name

a_co2 = pd.read_csv(a_co2_file)
a_light = pd.read_csv(a_light_file)

# ===== Predict parameters

env_input = {
    "co2_steps": dataset.co2_steps,
    "light_a_co2": dataset.light_a_co2,
    "light_steps": dataset.light_steps,
    "co2_a_light": dataset.co2_a_light,
    }

curve_input = {
    "a_co2": a_co2.to_numpy(),
    "a_light": a_light.to_numpy()
    }

# Predict model parameters
pred_params = c4tune.predict(curve_input, env_input)

```
### User interface
[To be added]

## Re-training the model
[To be added]


